<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsWire Search</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f9fafb;
            color: #111827;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .header p {
            color: #6b7280;
            font-size: 14px;
        }

        .search-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px;
            font-size: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            border-color: #3b82f6;
        }

        .search-box input::placeholder {
            color: #9ca3af;
        }

        .fuzzy-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .fuzzy-toggle input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .recent-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .recent-btn:hover {
            background: #f3f4f6;
        }

        .search-mode-container {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px 16px;
        }

        .search-mode-label {
            font-size: 13px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
            display: block;
        }

        .search-mode-options {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .search-mode-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
        }

        .search-mode-option input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .search-mode-option label {
            cursor: pointer;
            user-select: none;
        }

        .category-pills {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-pill {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
        }

        .category-pill:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .category-pill.active {
            background: #111827;
            color: #ffffff;
            border-color: #111827;
        }

        .main-layout {
            display: flex;
            gap: 30px;
        }

        .sidebar {
            width: 200px;
            flex-shrink: 0;
        }

        .filter-section {
            margin-bottom: 24px;
            background: white;
            padding: 16px;
            border-radius: 12px;
        }

        .filter-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 14px;
            color: #4b5563;
            cursor: pointer;
        }

        .filter-option:hover {
            color: #111827;
        }

        .filter-option input[type="checkbox"],
        .filter-option input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .filter-section.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .results-container {
            flex: 1;
            min-width: 0;
        }

        .performance-metrics {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .metric-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-label {
            font-size: 13px;
            color: #3b82f6;
            font-weight: 500;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .command-accordion {
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }

        .command-header {
            padding: 12px 16px;
            background: #f9fafb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
        }

        .command-header:hover {
            background: #f3f4f6;
        }

        .command-content {
            padding: 16px;
            background: #1f2937;
            color: #10b981;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .article-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s, border-color 0.2s;
        }

        .article-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #d1d5db;
        }

        .similarity-score {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .article-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
            line-height: 1.4;
            cursor: pointer;
        }

        .article-card h3:hover {
            color: #3b82f6;
        }

        .article-card h3 mark {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .article-summary {
            color: #374151;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .article-summary mark {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .find-similar-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            font-size: 13px;
            color: #1e40af;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .find-similar-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .load-more-btn {
            width: 100%;
            padding: 14px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
            transition: background 0.2s;
        }

        .load-more-btn:hover {
            background: #2563eb;
        }

        .trending-sidebar {
            width: 250px;
            flex-shrink: 0;
            background: white;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .trending-header {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
        }

        .trending-item {
            padding: 10px 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            font-size: 14px;
        }

        .trending-item:hover {
            background: #e5e7eb;
        }

        .trending-count {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 16px;
            background: white;
            border-radius: 8px;
        }

        .article-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .article-panel-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .article-panel-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            padding: 8px 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: #e5e7eb;
        }

        .full-article {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .full-article h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .full-article-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .full-article-content {
            font-size: 15px;
            line-height: 1.8;
            color: #374151;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .trending-sidebar {
                width: 100%;
                position: relative;
            }

            .article-panel {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [query, setQuery] = useState('');
            const [searchMode, setSearchMode] = useState('text');
            const [results, setResults] = useState([]);
            const [totalResults, setTotalResults] = useState(0);
            const [loading, setLoading] = useState(false);
            const [latency, setLatency] = useState(0);
            const [selectedCategories, setSelectedCategories] = useState(['All']);
            const [selectedSources, setSelectedSources] = useState(['All']);
            const [sort, setSort] = useState('relevance');
            const [fuzzy, setFuzzy] = useState(false);
            const [offset, setOffset] = useState(0);
            const limit = 10;

            const [categories, setCategories] = useState([]);
            const [sources, setSources] = useState([]);
            const [trending, setTrending] = useState([]);

            const [selectedArticle, setSelectedArticle] = useState(null);
            const [command, setCommand] = useState('');
            const [showCommand, setShowCommand] = useState(false);

            const [isSearchMode, setIsSearchMode] = useState(true); // Start in search mode
            const [showAutocomplete, setShowAutocomplete] = useState(false);
            const [autocompleteResults, setAutocompleteResults] = useState([]);

            // Prevent infinite loop - track if we should search
            const shouldAutoSearch = useRef(false);
            // const autocompleteTimer = useRef(null);

            // AUTO-SEARCH: Only when filters change AND we have a query or active filters
            useEffect(() => {
                if (shouldAutoSearch.current) {
                    // Only auto-search if there's actually something to search
                    if (query || !selectedCategories.includes('All') || !selectedSources.includes('All')) {
                        performSearch();
                    }
                }
                shouldAutoSearch.current = true;
            }, [searchMode, selectedCategories, selectedSources, sort, fuzzy]);
            useEffect(() => {
                const initializeApp = async () => {
                    await loadCategories();
                    await loadSources();
                    await loadTrending();
                    // After data loads, show initial articles
                    setTimeout(() => {
                        performSearch('', 0);
                    }, 500);
                };
                initializeApp();
            }, []);

            const loadCategories = async () => {
                try {
                    const res = await fetch('/api/categories');
                    const data = await res.json();
                    if (data.categories && data.categories.length > 0) {
                        setCategories(data.categories);
                    } else {
                        // Fallback categories if API fails
                        setCategories([
                            { name: 'General', count: 0 },
                            { name: 'Business', count: 0 },
                            { name: 'World', count: 0 },
                            { name: 'Entertainment', count: 0 },
                            { name: 'Politics', count: 0 },
                            { name: 'Sports', count: 0 },
                            { name: 'Technology', count: 0 },
                            { name: 'Health', count: 0 },
                            { name: 'Lifestyle', count: 0 }
                        ]);
                    }
                } catch (err) {
                    console.error('Failed to load categories:', err);
                    // Use fallback
                    setCategories([
                        { name: 'General', count: 0 },
                        { name: 'Business', count: 0 }
                    ]);
                }
            };

            const loadSources = async () => {
                try {
                    const res = await fetch('/api/sources');
                    const data = await res.json();
                    setSources(data.sources || []);
                } catch (err) {
                    console.error('Failed to load sources:', err);
                }
            };

            const loadTrending = async () => {
                try {
                    const res = await fetch('/api/trending');
                    const data = await res.json();
                    setTrending(data.trending || []);
                } catch (err) {
                    console.error('Failed to load trending:', err);
                }
            };

            const toggleSource = (sourceName) => {
                if (sourceName === 'All') {
                    setSelectedSources(['All']);
                } else {
                    const filtered = selectedSources.filter(s => s !== 'All');
                    if (filtered.includes(sourceName)) {
                        const newSources = filtered.filter(s => s !== sourceName);
                        setSelectedSources(newSources.length === 0 ? ['All'] : newSources);
                    } else {
                        setSelectedSources([...filtered, sourceName]);
                    }
                }
            };

            const getSourceParam = () => {
                if (selectedSources.includes('All') || selectedSources.length === 0) {
                    return 'All';
                }
                // FIXED: Return individual source for single selection, comma-separated for multiple
                if (selectedSources.length === 1) {
                    return selectedSources[0];
                }
                return selectedSources.join(',');
            };
            const getCategoryParam = () => {
                if (selectedCategories.includes('All') || selectedCategories.length === 0) {
                    return 'All';
                }
                if (selectedCategories.length === 1) {
                    return selectedCategories[0];
                }
                return selectedCategories.join(',');
            };
            const performSearch = async (searchQuery = query, searchOffset = 0) => {
                const sourceParam = getSourceParam();
                const categoryParam = getCategoryParam();

                // Always show results - sort is also a filter
                setIsSearchMode(true);

                setLoading(true);
                setOffset(searchOffset);

                const start = performance.now();
                try {
                    let url;
                    if (searchMode === 'vector') {
                        url = `/api/search/vector?q=${encodeURIComponent(searchQuery)}&category=${categoryParam}&source=${sourceParam}&offset=${searchOffset}&limit=${limit}`;
                    } else if (searchMode === 'hybrid') {
                        url = `/api/search/hybrid?q=${encodeURIComponent(searchQuery)}&category=${categoryParam}&source=${sourceParam}&offset=${searchOffset}&limit=${limit}`;
                    } else {
                        url = `/api/search?q=${encodeURIComponent(searchQuery)}&category=${categoryParam}&source=${sourceParam}&sort=${sort}&fuzzy=${fuzzy}&offset=${searchOffset}&limit=${limit}`;
                    }

                    const res = await fetch(url);
                    const data = await res.json();
                    const end = performance.now();

                    setLatency(end - start);
                    setResults(searchOffset === 0 ? data.results || [] : [...results, ...(data.results || [])]);
                    setTotalResults(data.total || 0);
                    setCommand(data.command || '');
                } catch (err) {
                    console.error('Search failed:', err);
                    setResults([]);
                    setTotalResults(0);
                } finally {
                    setLoading(false);
                }
            };

            const handleSearch = (e) => {
                if (e) e.preventDefault();
                performSearch();
            };

            const loadMore = () => {
                performSearch(query, offset + limit);
            };

            const viewArticle = async (articleId) => {
                try {
                    const res = await fetch(`/api/article/${articleId}`);
                    const data = await res.json();
                    if (data.article) {
                        setSelectedArticle(data.article);
                    }
                } catch (err) {
                    console.error('Failed to load article:', err);
                }
            };

            const [showSimilarModal, setShowSimilarModal] = useState(false);
            const [similarArticles, setSimilarArticles] = useState([]);
            const [similarToArticle, setSimilarToArticle] = useState(null);
            const [loadingSimilar, setLoadingSimilar] = useState(false);

            const findSimilar = async (articleId, articleTitle) => {
                setLoadingSimilar(true);
                setSimilarToArticle({ id: articleId, title: articleTitle });
                setShowSimilarModal(true);

                try {
                    const res = await fetch(`/api/similar/${articleId}?limit=5`);
                    const data = await res.json();

                    if (data.similar && data.similar.length > 0) {
                        setSimilarArticles(data.similar);
                    } else {
                        setSimilarArticles([]);
                    }
                } catch (err) {
                    console.error('Find similar error:', err);
                    setSimilarArticles([]);
                } finally {
                    setLoadingSimilar(false);
                }
            };


            const handleQueryChange = async (e) => {
                const value = e.target.value;
                setQuery(value);

                if (value.length >= 2) {
                    try {
                        const res = await fetch(`/api/autocomplete?q=${encodeURIComponent(value)}&limit=7`);
                        const data = await res.json();
                        if (data.suggestions && data.suggestions.length > 0) {
                            setAutocompleteResults(data.suggestions);
                            setShowAutocomplete(true);
                        } else {
                            setShowAutocomplete(false);
                        }
                    } catch (err) {
                        console.error('Autocomplete error:', err);
                        setShowAutocomplete(false);
                    }
                } else {
                    setShowAutocomplete(false);
                }
            };

            const selectSuggestion = (suggestion) => {
                setQuery(suggestion.title);
                setShowAutocomplete(false);
                performSearch(suggestion.title, 0);
            };

            const searchTrendingTag = (tag) => {
                setQuery(tag);
                setTimeout(() => performSearch(tag), 100);
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>üì∞ NewsWire Search</h1>
                        <p>Professional news search powered by Azure Managed Redis (RediSearch)</p>
                    </div>

                    <div className="search-section">
                        <form onSubmit={handleSearch}>
                            <div className="search-row">
                                <div className="search-box" style={{ position: 'relative' }}>
                                    <input
                                        type="text"
                                        placeholder="Search for news, topics or sources..."
                                        value={query}
                                        onChange={handleQueryChange}
                                        onBlur={() => setTimeout(() => setShowAutocomplete(false), 200)}
                                    />
                                    {showAutocomplete && autocompleteResults.length > 0 && (
                                        <div style={{
                                            position: 'absolute',
                                            top: '100%',
                                            left: 0,
                                            right: 0,
                                            backgroundColor: 'white',
                                            border: '1px solid #e5e7eb',
                                            borderRadius: '8px',
                                            marginTop: '4px',
                                            maxHeight: '300px',
                                            overflowY: 'auto',
                                            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                            zIndex: 1000
                                        }}>
                                            <div style={{
                                                padding: '8px 12px',
                                                fontSize: '12px',
                                                color: '#6b7280',
                                                borderBottom: '1px solid #e5e7eb',
                                                fontWeight: 600
                                            }}>
                                                {searchMode === 'text' && 'Matching articles'}
                                                {searchMode === 'vector' && 'Suggested topics (will use semantic search)'}
                                                {searchMode === 'hybrid' && 'Suggested topics (combined search)'}
                                            </div>
                                            {autocompleteResults.map((sugg, idx) => (
                                                <div
                                                    key={idx}
                                                    onClick={() => selectSuggestion(sugg)}
                                                    style={{
                                                        padding: '12px',
                                                        cursor: 'pointer',
                                                        borderBottom: idx < autocompleteResults.length - 1 ? '1px solid #f3f4f6' : 'none',
                                                        fontSize: '14px',
                                                        color: '#111827',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px'
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f9fafb'}
                                                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'white'}
                                                >
                                                    <span style={{ fontSize: '16px' }}>
                                                        {sugg.type === 'topic' ? 'üè∑Ô∏è' : 'üì∞'}
                                                    </span>
                                                    <span style={{ flex: 1 }}>
                                                        {sugg.title}
                                                    </span>
                                                    {sugg.type === 'article' && (
                                                        <span style={{ fontSize: '11px', color: '#9ca3af' }}>article</span>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="fuzzy-toggle">
                                    <input
                                        type="checkbox"
                                        id="fuzzy"
                                        checked={fuzzy}
                                        onChange={(e) => setFuzzy(e.target.checked)}
                                        disabled={searchMode !== 'text'}
                                    />
                                    <label htmlFor="fuzzy">üîç Fuzzy search</label>
                                </div>

                            </div>
                        </form>

                        <div className="search-mode-container">
                            <span className="search-mode-label">üîç Search Mode:</span>
                            <div className="search-mode-options">
                                <div className="search-mode-option">
                                    <input
                                        type="radio"
                                        id="mode-text"
                                        name="searchMode"
                                        value="text"
                                        checked={searchMode === 'text'}
                                        onChange={(e) => setSearchMode(e.target.value)}
                                    />
                                    <label htmlFor="mode-text">Text (Keyword)</label>
                                </div>
                                <div className="search-mode-option">
                                    <input
                                        type="radio"
                                        id="mode-vector"
                                        name="searchMode"
                                        value="vector"
                                        checked={searchMode === 'vector'}
                                        onChange={(e) => setSearchMode(e.target.value)}
                                    />
                                    <label htmlFor="mode-vector">Vector (Semantic)</label>
                                </div>
                                <div className="search-mode-option">
                                    <input
                                        type="radio"
                                        id="mode-hybrid"
                                        name="searchMode"
                                        value="hybrid"
                                        checked={searchMode === 'hybrid'}
                                        onChange={(e) => setSearchMode(e.target.value)}
                                    />
                                    <label htmlFor="mode-hybrid">Hybrid (Recommended)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Category Pills */}
                    <div className="category-pills">
                        <div
                            className={`category-pill ${selectedCategories.includes('All') ? 'active' : ''}`}
                            onClick={() => setSelectedCategories(['All'])}
                        >
                            All
                        </div>
                        {categories.slice(0, 10).map((cat) => (
                            <div
                                key={cat.name}
                                className={`category-pill ${selectedCategories.includes(cat.name) ? 'active' : ''}`}
                                onClick={() => {
                                    if (cat.name === 'All') {
                                        setSelectedCategories(['All']);
                                    } else {
                                        const filtered = selectedCategories.filter(c => c !== 'All');
                                        if (filtered.includes(cat.name)) {
                                            const newCats = filtered.filter(c => c !== cat.name);
                                            setSelectedCategories(newCats.length === 0 ? ['All'] : newCats);
                                        } else {
                                            const newSelected = [...filtered, cat.name];
                                            // If all categories selected, switch to "All"
                                            if (newSelected.length === categories.length) {
                                                setSelectedCategories(['All']);
                                            } else {
                                                setSelectedCategories(newSelected);
                                            }
                                        }
                                    }
                                }}
                            >
                                {cat.name}
                            </div>
                        ))}
                    </div>

                    <div className="main-layout">
                        {/* Left Sidebar */}
                        <div className="sidebar">
                            {/* Source Filters */}
                            <div className="filter-section">
                                <h3>üì∞ Source</h3>
                                <div className="filter-option">
                                    <input
                                        type="checkbox"
                                        checked={selectedSources.includes('All')}
                                        onChange={() => toggleSource('All')}
                                    />
                                    <span>All</span>
                                </div>
                                {sources.slice(0, 10).map((src) => (
                                    <div key={src.name} className="filter-option">
                                        <input
                                            type="checkbox"
                                            checked={selectedSources.includes(src.name)}
                                            onChange={() => toggleSource(src.name)}
                                        />
                                        <span>{src.name}</span>
                                    </div>
                                ))}
                            </div>

                            {/* Sort By - Only for Text mode */}
                            <div className={`filter-section ${searchMode !== 'text' ? 'disabled' : ''}`}>
                                <h3>üìä Sort By {searchMode !== 'text' && '(Text mode only)'}</h3>
                                <div className="filter-option">
                                    <input
                                        type="radio"
                                        name="sort"
                                        checked={sort === 'relevance'}
                                        onChange={() => setSort('relevance')}
                                        disabled={searchMode !== 'text'}
                                    />
                                    <span>Relevance</span>
                                </div>
                                <div className="filter-option">
                                    <input
                                        type="radio"
                                        name="sort"
                                        checked={sort === 'date_desc'}
                                        onChange={() => setSort('date_desc')}
                                        disabled={searchMode !== 'text'}
                                    />
                                    <span>Newest First</span>
                                </div>
                                <div className="filter-option">
                                    <input
                                        type="radio"
                                        name="sort"
                                        checked={sort === 'date_asc'}
                                        onChange={() => setSort('date_asc')}
                                        disabled={searchMode !== 'text'}
                                    />
                                    <span>Oldest First</span>
                                </div>
                            </div>
                        </div>

                        {/* Main Results */}
                        <div className="results-container">
                            {isSearchMode && (
                                <>
                                    <div className="performance-metrics">
                                        <div className="metric-item">
                                            <span className="metric-label">‚ö° Query Speed</span>
                                            <span className="metric-value">{latency.toFixed(2)}ms</span>
                                        </div>
                                        <div className="metric-item">
                                            <span className="metric-label">üìä Total Results</span>
                                            <span className="metric-value">{totalResults.toLocaleString()}</span>
                                        </div>
                                        <div className="metric-item">
                                            <span className="metric-label">üìÑ On Page</span>
                                            <span className="metric-value">{results.length}</span>
                                        </div>
                                    </div>

                                    {command && (
                                        <div className="command-accordion">
                                            <div
                                                className="command-header"
                                                onClick={() => setShowCommand(!showCommand)}
                                            >
                                                <span>üìù Redis Command</span>
                                                <span>{showCommand ? '‚ñº' : '‚ñ∂'}</span>
                                            </div>
                                            {showCommand && (
                                                <div className="command-content">{command}</div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}

                            {loading && <div className="loading">Loading...</div>}

                            {!loading && isSearchMode && results.length === 0 && (
                                <div className="no-results">No results found. Try different search terms or filters.</div>
                            )}

                            {!loading && !isSearchMode && (
                                <div className="no-results">
                                    Enter a search query or select filters to see results.
                                </div>
                            )}

                            {results.map((article, index) => (
                                <div key={article.id || index} className="article-card">
                                    {/* Similarity score - only show if exists */}
                                    {(searchMode === 'vector' || searchMode === 'hybrid') && article.similarity_score !== undefined && (
                                        <div className="similarity-score">
                                            üéØ {Math.round((1 - article.similarity_score) * 100)}% match
                                        </div>
                                    )}

                                    <h3
                                        onClick={() => viewArticle(article.id)}
                                        dangerouslySetInnerHTML={{
                                            __html: article.title || 'No title'
                                        }}
                                    />

                                    <div className="article-meta">
                                        <span>üìÅ {article.category || 'General'}</span>
                                        <span>‚úçÔ∏è {article.author || 'Unknown'}</span>
                                        <span>üìÖ {article.published_at || 'N/A'}</span>
                                        <span>üì∞ {article.source || 'N/A'}</span>
                                        <span>üìù {parseInt(article.word_count || 0).toLocaleString()} words</span>
                                    </div>

                                    <p
                                        className="article-summary"
                                        dangerouslySetInnerHTML={{
                                            __html: article.summary || article.content?.substring(0, 200) + '...' || 'No summary available.'
                                        }}
                                    />

                                    {(searchMode === 'vector' || searchMode === 'hybrid') && (
                                        <button
                                            className="find-similar-btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                findSimilar(article.id, article.title);
                                            }}
                                            title="Find articles with similar content using AI"
                                        >
                                            üîç Find Similar Articles
                                        </button>
                                    )}
                                </div>
                            ))}

                            {/* FIXED: Show Load More button when there are more results */}
                            {!loading && results.length > 0 && results.length < totalResults && (
                                <button className="load-more-btn" onClick={loadMore}>
                                    Load More Results ({totalResults - results.length} remaining)
                                </button>
                            )}
                        </div>

                        {/* Right Sidebar - Trending */}
                        <div className="trending-sidebar">
                            <div className="trending-header">üî• Trending Topics</div>
                            {trending.length === 0 ? (
                                <div style={{ fontSize: '12px', color: '#9ca3af', padding: '10px' }}>
                                    No trending topics available
                                </div>
                            ) : (
                                trending.map((item, idx) => (
                                    <div
                                        key={idx}
                                        className="trending-item"
                                        onClick={() => searchTrendingTag(item.tag)}
                                    >
                                        <span>{item.tag}</span>
                                        <span className="trending-count">{item.count}</span>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                    {/* Similar Articles Modal */}
                    {showSimilarModal && (
                        <div
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0,0,0,0.5)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 2000
                            }}
                            onClick={() => setShowSimilarModal(false)}
                        >
                            <div
                                style={{
                                    backgroundColor: 'white',
                                    borderRadius: '12px',
                                    width: '600px',
                                    maxHeight: '80vh',
                                    overflow: 'auto',
                                    boxShadow: '0 20px 25px -5px rgba(0,0,0,0.1)'
                                }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div style={{
                                    padding: '20px',
                                    borderBottom: '1px solid #e5e7eb',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'start'
                                }}>
                                    <div>
                                        <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 600 }}>
                                            Similar Articles
                                        </h3>
                                        {similarToArticle && (
                                            <p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>
                                                Similar to: <strong>{similarToArticle.title}</strong>
                                            </p>
                                        )}
                                    </div>
                                    <button
                                        onClick={() => setShowSimilarModal(false)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            fontSize: '24px',
                                            cursor: 'pointer',
                                            color: '#6b7280',
                                            padding: '0',
                                            lineHeight: 1
                                        }}
                                    >
                                        √ó
                                    </button>
                                </div>

                                <div style={{ padding: '20px' }}>
                                    {loadingSimilar && (
                                        <div style={{ textAlign: 'center', padding: '40px', color: '#6b7280' }}>
                                            Loading similar articles...
                                        </div>
                                    )}

                                    {!loadingSimilar && similarArticles.length === 0 && (
                                        <div style={{ textAlign: 'center', padding: '40px', color: '#6b7280' }}>
                                            No similar articles found
                                        </div>
                                    )}

                                    {!loadingSimilar && similarArticles.length > 0 && (
                                        <div>
                                            {similarArticles.map((article, idx) => {
                                                const isSameCategory = similarToArticle && article.category === similarToArticle.title.split(' ')[0];
                                                return (
                                                    <div
                                                        key={article.id}
                                                        style={{
                                                            padding: '16px',
                                                            marginBottom: '12px',
                                                            border: '1px solid #e5e7eb',
                                                            borderRadius: '8px',
                                                            cursor: 'pointer'
                                                        }}
                                                        onClick={() => {
                                                            viewArticle(article.id);
                                                            setShowSimilarModal(false);
                                                        }}
                                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f9fafb'}
                                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'white'}
                                                    >
                                                        {article.similarity_score && (
                                                            <div style={{
                                                                display: 'inline-block',
                                                                padding: '4px 8px',
                                                                backgroundColor: '#dbeafe',
                                                                color: '#1e40af',
                                                                borderRadius: '4px',
                                                                fontSize: '12px',
                                                                fontWeight: 600,
                                                                marginBottom: '8px'
                                                            }}>
                                                                üéØ {Math.round((1 - parseFloat(article.similarity_score)) * 100)}% similar
                                                            </div>
                                                        )}

                                                        <h4 style={{
                                                            margin: '0 0 8px 0',
                                                            fontSize: '16px',
                                                            fontWeight: 600,
                                                            color: '#111827'
                                                        }}>
                                                            {article.title}
                                                        </h4>

                                                        <div style={{
                                                            display: 'flex',
                                                            gap: '12px',
                                                            fontSize: '13px',
                                                            color: '#6b7280',
                                                            marginBottom: '8px'
                                                        }}>
                                                            <span>üìÅ {article.category}</span>
                                                            <span>üì∞ {article.source}</span>
                                                            {article.published_at && (
                                                                <span>üìÖ {new Date(article.published_at).toLocaleDateString()}</span>
                                                            )}
                                                        </div>

                                                        {article.category && (
                                                            <div style={{
                                                                fontSize: '12px',
                                                                color: '#059669',
                                                                marginTop: '8px',
                                                                padding: '8px',
                                                                backgroundColor: '#ecfdf5',
                                                                borderRadius: '4px'
                                                            }}>
                                                                üí° Similar because: Both articles are about {article.category}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Article Detail Panel */}
                    {selectedArticle && (
                        <div className="article-panel">
                            <div className="article-panel-header">
                                <h3>üìÑ Full Article</h3>
                                <button
                                    className="close-btn"
                                    onClick={() => setSelectedArticle(null)}
                                >
                                    ‚úï Close
                                </button>
                            </div>
                            <div className="full-article">
                                <h2>{selectedArticle.title}</h2>
                                <div className="full-article-meta">
                                    <span><strong>Category:</strong> {selectedArticle.category}</span>
                                    <span><strong>Source:</strong> {selectedArticle.source}</span>
                                    <span><strong>Author:</strong> {selectedArticle.author}</span>
                                    <span><strong>Published:</strong> {selectedArticle.published_at}</span>
                                    <span><strong>Words:</strong> {selectedArticle.word_count}</span>
                                </div>
                                <hr style={{ border: 'none', borderTop: '1px solid #e5e7eb', margin: '20px 0' }} />
                                <div className="full-article-content">
                                    {selectedArticle.content}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>
